# 測試錯誤修復綜合計劃

## 概述
根據測試結果分析，發現多個層面的問題需要修復，包括缺失的模組、配置錯誤、測試邏輯問題和 E2E 測試失敗。

## 錯誤分類與修復計劃

### 1. 缺失模組問題 (高優先級)

#### 1.1 主題上下文模組缺失
**問題**: `@/contexts/theme-context` 模組不存在
**影響**: 15個 ThemeToggle 相關測試失敗
**修復任務**: 
- 創建 `src/contexts/theme-context.tsx`
- 實作 `useThemeToggle` hook
- 提供主題狀態管理功能

#### 1.2 統一搜尋 Hook 缺失
**問題**: `@/hooks/use-unified-search` 模組不存在
**影響**: 18個 SearchBar 相關測試失敗
**修復任務**:
- 創建 `src/hooks/use-unified-search.ts`
- 整合股票和加密貨幣搜尋功能
- 提供統一的搜尋介面

#### 1.3 追蹤清單管理器缺失
**問題**: WatchlistManager 組件測試找不到相關 store
**影響**: 22個 WatchlistManager 測試失敗
**修復任務**:
- 檢查 `@/stores/watchlist-store` 路徑
- 確保 `@/hooks/use-watchlist-prices` 存在

### 2. 測試配置問題 (高優先級)

#### 2.1 Vitest Mock 配置錯誤
**問題**: Mock 變數在初始化前被存取
**影響**: CandlestickChart 和 ChartModal 測試失敗
**修復任務**:
- 修正 mock 變數的宣告順序
- 使用 `vi.hoisted()` 確保正確的提升

#### 2.2 Playwright 配置衝突
**問題**: E2E 測試無法正確載入 test.describe
**影響**: 所有 E2E 測試失敗
**修復任務**:
- 檢查 Playwright 版本衝突
- 修正測試配置檔案
- 確保正確的測試環境設定

### 3. API 測試問題 (中優先級)

#### 3.1 CoinGecko API 測試超時
**問題**: 錯誤處理測試超時
**影響**: 2個 CoinGecko 測試失敗
**修復任務**:
- 修正 mock fetch 的 `response.text()` 方法
- 調整測試超時設定
- 改善錯誤處理邏輯

#### 3.2 圖表資料測試邏輯錯誤
**問題**: 時間範圍計算不一致
**影響**: 2個 ChartDataClient 測試失敗
**修復任務**:
- 修正時間範圍配置邏輯
- 統一日期計算方法

### 4. E2E 測試問題 (中優先級)

#### 4.1 頁面元素找不到
**問題**: 所有 E2E 測試都找不到基本 UI 元素
**影響**: 190個 E2E 測試失敗
**修復任務**:
- 檢查應用程式是否正確啟動
- 確認 data-testid 屬性存在
- 修正頁面路由和組件渲染

#### 4.2 測試環境配置
**問題**: 測試環境可能未正確設定
**修復任務**:
- 確保開發伺服器正確啟動
- 檢查環境變數配置
- 修正基礎 URL 設定

### 5. 環境變數問題 (低優先級)

#### 5.1 API 金鑰缺失警告
**問題**: Alpha Vantage API 金鑰未設定
**影響**: 測試警告訊息
**修復任務**:
- 在測試環境中設定 mock API 金鑰
- 或在測試中忽略此警告

## 修復順序建議

### 階段 1: 基礎模組修復 (1-2天)
1. 創建缺失的 context 和 hooks
2. 修正 import 路徑問題
3. 確保基本功能模組完整

### 階段 2: 測試配置修復 (1天)
1. 修正 Vitest mock 配置
2. 解決 Playwright 配置衝突
3. 調整測試超時設定

### 階段 3: 單元測試修復 (1-2天)
1. 修正 API 測試邏輯
2. 調整時間相關的測試
3. 確保所有單元測試通過

### 階段 4: E2E 測試修復 (2-3天)
1. 確保應用程式正確啟動
2. 修正頁面元素選擇器
3. 調整測試流程和等待邏輯

### 階段 5: 整合測試和優化 (1天)
1. 執行完整測試套件
2. 修正剩餘問題
3. 優化測試效能

## 成功指標

### 單元測試目標
- 所有 438 個單元測試通過 (目前 368 通過)
- 測試覆蓋率維持在 80% 以上
- 無測試超時或配置錯誤

### E2E 測試目標
- 所有 190 個 E2E 測試通過 (目前 0 通過)
- 測試執行時間控制在合理範圍內
- 跨瀏覽器相容性確保

### 整體品質目標
- CI/CD 管道穩定執行
- 開發體驗流暢
- 測試維護成本降低

## 風險評估

### 高風險項目
1. E2E 測試修復可能需要重大架構調整
2. 缺失模組可能影響現有功能
3. 測試配置變更可能引入新問題

### 緩解策略
1. 分階段進行，每階段驗證
2. 保持現有通過測試的穩定性
3. 建立回滾機制

## 資源需求

### 開發時間
- 預估總時間: 7-10 個工作天
- 關鍵路徑: 基礎模組 → 測試配置 → E2E 修復

### 技術需求
- React/Next.js 專業知識
- 測試框架經驗 (Vitest, Playwright)
- TypeScript 和模組系統理解

## 後續維護

### 預防措施
1. 建立測試覆蓋率監控
2. 設定 CI/CD 品質門檻
3. 定期測試環境健康檢查

### 文件更新
1. 更新測試執行指南
2. 建立故障排除文件
3. 維護測試最佳實踐指南