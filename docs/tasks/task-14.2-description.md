# Task 15: 修復 ChartModal 組件測試

## 基本資訊
- **任務編號**: Task 15
- **任務類型**: 測試修復
- **優先級**: 高
- **狀態**: 已完成
- **開始時間**: 2025-09-03
- **完成時間**: 2025-09-03

## 任務描述
修復 ChartModal 組件的測試文件，解決測試失敗問題。原測試文件使用了錯誤的 API 和 mock 設置，導致所有 13 個測試都失敗。

## 問題分析
1. **API 不匹配**: 測試中使用 `open` 和 `item` props，但實際組件使用 `isOpen` 和從 store 獲取的 `currentAsset`
2. **Mock 設置錯誤**: useChartData 和 useChartStore 的 mock 返回值格式不正確
3. **測試邏輯錯誤**: 測試期望的元素和行為與實際組件實現不符

## 實作步驟

### 1. 分析現有測試失敗原因
- 檢查 ChartModal 組件的實際 API
- 分析測試失敗的具體錯誤訊息
- 確認組件的依賴關係和 store 使用方式

### 2. 重寫測試文件
- 修正 mock 設置，使用正確的變數宣告順序
- 更新測試用例以匹配實際的組件 API
- 修正 useChartData 和 useChartStore 的 mock 返回值格式

### 3. 測試用例優化
- 移除不相關的測試用例
- 添加針對實際功能的測試
- 確保測試覆蓋主要功能路徑

## 建立/修改檔案

### 修改檔案
- `src/components/charts/__tests__/ChartModal.test.tsx`: 完全重寫測試文件

## 技術決策

### Mock 策略
- 使用 `vi.mock()` 正確 mock 外部依賴
- 確保 mock 函數的宣告順序符合 Vitest 要求
- 提供符合實際 API 的 mock 返回值

### 測試覆蓋範圍
- 基本渲染測試
- 用戶交互測試（關閉、全螢幕切換等）
- 錯誤狀態和載入狀態測試
- 鍵盤事件處理測試

## 測試結果

### 修復前
- **測試文件**: 1 個
- **測試用例**: 13 個失敗
- **通過率**: 0%
- **主要問題**: API 不匹配、Mock 設置錯誤

### 修復後
- **測試文件**: 1 個
- **測試用例**: 17 個通過
- **通過率**: 100%
- **覆蓋功能**: 完整的組件功能測試

### 整體圖表組件測試狀況
- **測試文件**: 5 個全部通過
- **測試用例**: 51 個全部通過
- **通過率**: 100%

## 問題解決

### 主要問題
1. **Mock 變數宣告順序**: 解決了 Vitest 中 mock 變數的初始化順序問題
2. **API 不匹配**: 統一了測試和實際組件的 API 使用方式
3. **數據格式錯誤**: 修正了 mock 數據的格式以匹配實際的 hook 返回值

### 解決方案
- 重新組織 mock 宣告順序
- 使用正確的組件 props API
- 提供符合實際格式的測試數據

## 後續工作
1. 監控測試穩定性
2. 考慮添加更多邊界情況測試
3. 優化測試性能和可讀性

## 學習要點
1. Vitest mock 系統的正確使用方式
2. React 組件測試的最佳實踐
3. 測試與實際代碼 API 一致性的重要性